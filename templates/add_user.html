{% extends 'index.html' %}
{% block content %}
    <div>
        <h4>Add User</h4>
        <br>
        <div class="d-flex">
            <div>
                <label for="">First Name</label>
                <input class="form-control" type="text" name="first_name" id="id_first_name">
                <span style="color: red;" id="id_first_name_error"></span>
            </div>
            <div style="margin-left: 25px;">
                <label for="">Last Name</label>
                <input class="form-control" type="text" name="last_name" id="id_last_name">
                <span style="color: red;" id="id_last_name_error"></span>
            </div>
            <div style="margin-left: 25px;">
                <label for="">Email</label>
                <input class="form-control" type="email" name="email" id="id_email">
                <span style="color: red;" id="id_email_error"></span>
            </div>
            <div style="width: 220px;margin-left: 25px;">
                <label for="">Role</label>
                <select class="form-control" name="role" id="id_role">
                    <option value="">Select Role</option>
                    {% for role in roles %}
                        <option value="{{role.id}}">{{role.role_name}}</option>
                    {% endfor %}
                </select>
                <span style="color: red;" id="id_role_error"></span>
            </div>
        </div>
        <br>
        <div class="d-flex">
            <div>
                <label for="">Username</label>
                <input class="form-control" type="text" name="username" id="id_username">
                <span style="color: red;" id="id_username_error"></span>
            </div>
            <div style="margin-left: 25px;">
                <label for="">Password</label>
                <input class="form-control" type="text" name="password" id="id_password">
                <span style="color: red;" id="id_password_error"></span>
            </div>
            <div style="margin-left: 25px;">
                <label for="">Confirm Password</label>
                <input class="form-control" type="text" name="confirm_password" id="id_confirm_password">
                <span style="color: red;" id="id_confirm_password_error"></span>
            </div>
            <div style="margin-left: 25px;">
                <label for="">Id</label>
                <input class="form-control" type="text" name="id" id="id_id">
                <span style="color: red;" id="id_id_error"></span>
            </div>
            <div style="margin-left: 25px; margin-top: 7px;">
                <label for=""></label>
                <button class="form-control btn-primary" onclick="addUser()">Add</button>
            </div>
        </div>
    </div>
    <br><br>
    <div id="id_list_users">
        <table class="table">
            <thead>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Username</th>
                <th>Id</th>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr>
                        <td>{{user.user__first_name}}</td>
                        <td>{{user.user__last_name}}</td>
                        <td>{{user.user__email}}</td>
                        <td>{{user.role__role_name}}</td>
                        <td>{{user.user__username}}</td>
                        <td>{{user.unique_id}}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        function addUser(){
            document.getElementById('id_first_name_error').innerHTML='';
            document.getElementById('id_last_name_error').innerHTML='';
            document.getElementById('id_email_error').innerHTML='';
            document.getElementById('id_role_error').innerHTML='';
            document.getElementById('id_username_error').innerHTML='';
            document.getElementById('id_password_error').innerHTML='';
            document.getElementById('id_confirm_password_error').innerHTML='';
            document.getElementById('id_confirm_password_error').innerHTML='';
            document.getElementById('id_id_error').innerHTML='';
            var first_name = $("#id_first_name").val();
            var last_name = $("#id_last_name").val();
            var email = $("#id_email").val();
            var role = $("#id_role").val();
            var username = $("#id_username").val();
            var password = $("#id_password").val();
            var confirm_password = $("#id_confirm_password").val();
            var id = $("#id_id").val();
            var errors = false;
            var reg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
            if (first_name == '') {
                document.getElementById('id_first_name_error').innerHTML='Enter First Name';
                errors = true;
            }
            if (last_name == '') {
                document.getElementById('id_last_name_error').innerHTML='Enter last Name';
                errors = true;
            }
            if (email == '') {
                document.getElementById('id_email_error').innerHTML='Enter Email';
                errors = true;
            } else if (reg.test(email) == false) {
                document.getElementById('id_email_error').innerHTML='Invalid Email';
                errors = true;
            }
            if (role == '') {
                document.getElementById('id_role_error').innerHTML='Select Role';
                errors = true;
            }
            if (username == '') {
                document.getElementById('id_username_error').innerHTML='Enter Username';
                errors = true;
            }
            if (password == '') {
                document.getElementById('id_password_error').innerHTML='Enter Password';
                errors = true;
            }
            if (confirm_password == '') {
                document.getElementById('id_confirm_password_error').innerHTML='Enter Confirm Password';
                errors = true;
            } else if (password != confirm_password) {
                document.getElementById('id_confirm_password_error').innerHTML='Passwords Mismatch';
                errors = true;
            }
            if (id == '') {
                document.getElementById('id_id_error').innerHTML='Enter Id';
                errors = true;
            }
            if (!errors){
                $.ajax({
                    type: "POST",
                    url: "{% url 'save_user' %}",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'first_name': first_name,
                        'last_name': last_name,
                        'email': email,
                        'role': role,
                        'username': username,
                        'password': password,
                        'confirm_password': confirm_password,
                        'id': id,
                    },
                    success: function (data) {
                        if (data.status == 'failed'){
                            document.getElementById('id_error').innerHTML=data.message;
                        } else{
                            window.location = "{% url 'index'%}";
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}